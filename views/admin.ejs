<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Sport Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }
    .sidebar .nav-link {
      color: rgba(255,255,255,0.8);
      padding: 12px 20px;
      border-radius: 8px;
      margin: 4px 10px;
      transition: all 0.3s;
    }
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    .card-header {
      background: transparent;
      border-bottom: 1px solid #eee;
      font-weight: 600;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .stat-card.users { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.blogs { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); }
    .stat-card.threads { background: linear-gradient(135deg, #4776E6 0%, #8E54E9 100%); }
    .stat-card.archived { background: linear-gradient(135deg, #606c88 0%, #3f4c6b 100%); }
    .table th {
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
    }
    .badge-locked {
      background-color: #dc3545;
    }
    .badge-active {
      background-color: #28a745;
    }
    .badge-archived {
      background-color: #6c757d;
    }
    .btn-action {
      padding: 4px 12px;
      font-size: 0.85rem;
    }
    .tab-content {
      padding-top: 20px;
    }
    .nav-tabs .nav-link {
      color: #495057;
      font-weight: 500;
    }
    .nav-tabs .nav-link.active {
      color: #667eea;
      border-bottom: 2px solid #667eea;
    }
    .archived-row {
      background-color: #f8f9fa;
      opacity: 0.7;
    }
    .archived-badge {
      font-size: 0.7rem;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2 sidebar py-4">
        <div class="text-center mb-4">
          <h4 class="text-white">Sport Store</h4>
          <small class="text-white-50">Admin Panel</small>
        </div>
        <nav class="nav flex-column">
          <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
            <i class="bi bi-speedometer2 me-2"></i> Dashboard
          </a>
          <a class="nav-link" href="#users" data-bs-toggle="tab">
            <i class="bi bi-people me-2"></i> Users
          </a>
          <a class="nav-link" href="#blogs" data-bs-toggle="tab">
            <i class="bi bi-journal-text me-2"></i> Blogs
          </a>
          <a class="nav-link" href="#forum" data-bs-toggle="tab">
            <i class="bi bi-chat-dots me-2"></i> Forum
          </a>
          <a class="nav-link" href="#archived" data-bs-toggle="tab">
            <i class="bi bi-archive me-2"></i> Archived Content
          </a>
          <hr class="my-3 border-secondary">
          <a class="nav-link" href="/shop">
            <i class="bi bi-arrow-left me-2"></i> Back to Shop
          </a>
          <a class="nav-link" href="/logout">
            <i class="bi bi-box-arrow-right me-2"></i> Logout
          </a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="col-md-10 py-4">
        <div class="tab-content">
          <!-- Dashboard Tab -->
          <div class="tab-pane fade show active" id="dashboard">
            <h2 class="mb-4">Dashboard Overview</h2>
            <div class="row g-4 mb-4">
              <div class="col-md-3">
                <div class="card stat-card users">
                  <div class="card-body">
                    <h6 class="opacity-75">Total Users</h6>
                    <h2 class="mb-0"><%= users.length %></h2>
                    <small><%= users.filter(u => u.locked).length %> locked</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stat-card blogs">
                  <div class="card-body">
                    <h6 class="opacity-75">Total Blogs</h6>
                    <h2 class="mb-0"><%= blogs.length %></h2>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stat-card threads">
                  <div class="card-body">
                    <h6 class="opacity-75">Forum Threads</h6>
                    <h2 class="mb-0"><%= threads.filter(t => !t.archived).length %></h2>
                    <small>active threads</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stat-card archived">
                  <div class="card-body">
                    <h6 class="opacity-75">Archived</h6>
                    <h2 class="mb-0"><%= threads.filter(t => t.archived).length %></h2>
                    <small>threads archived</small>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-4">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <i class="bi bi-people me-2"></i> Recent Users
                  </div>
                  <div class="card-body">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Username</th>
                          <th>Role</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% users.slice(0, 5).forEach(u => { %>
                        <tr>
                          <td><%= u.username %></td>
                          <td><span class="badge bg-<%= u.role === 'admin' ? 'primary' : 'secondary' %>"><%= u.role %></span></td>
                          <td>
                            <span class="badge <%= u.locked ? 'badge-locked' : 'badge-active' %>">
                              <%= u.locked ? 'Locked' : 'Active' %>
                            </span>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <i class="bi bi-chat-dots me-2"></i> Recent Threads
                  </div>
                  <div class="card-body">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Title</th>
                          <th>Author</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% threads.slice(0, 5).forEach(t => { %>
                        <tr class="<%= t.archived ? 'archived-row' : '' %>">
                          <td><%= t.title ? t.title.substring(0, 30) : 'Untitled' %>...</td>
                          <td><%= t.author || 'Unknown' %></td>
                          <td>
                            <span class="badge <%= t.archived ? 'badge-archived' : 'badge-active' %>">
                              <%= t.archived ? 'Archived' : 'Active' %>
                            </span>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Users Tab -->
          <div class="tab-pane fade" id="users">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>User Management</h2>
              <span class="badge bg-primary"><%= users.length %> total users</span>
            </div>
            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Full Name</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% users.forEach(u => { %>
                      <tr id="user-row-<%= u.id %>">
                        <td><%= u.id %></td>
                        <td><strong><%= u.username %></strong></td>
                        <td><%= u.email %></td>
                        <td><%= u.fullname || '-' %></td>
                        <td>
                          <select class="form-select form-select-sm" style="width: auto;" 
                                  onchange="changeRole(<%= u.id %>, this.value)"
                                  <%= u.id === user.id ? 'disabled' : '' %>>
                            <option value="user" <%= u.role === 'user' ? 'selected' : '' %>>User</option>
                            <option value="admin" <%= u.role === 'admin' ? 'selected' : '' %>>Admin</option>
                          </select>
                        </td>
                        <td>
                          <span class="badge <%= u.locked ? 'badge-locked' : 'badge-active' %>" id="status-<%= u.id %>">
                            <%= u.locked ? 'Locked' : 'Active' %>
                          </span>
                        </td>
                        <td>
                          <% if (u.id !== user.id) { %>
                          <button class="btn btn-sm <%= u.locked ? 'btn-success' : 'btn-warning' %> btn-action" 
                                  onclick="toggleLock(<%= u.id %>)" id="lock-btn-<%= u.id %>">
                            <i class="bi <%= u.locked ? 'bi-unlock' : 'bi-lock' %>"></i>
                            <%= u.locked ? 'Unlock' : 'Lock' %>
                          </button>
                          <button class="btn btn-sm btn-danger btn-action" onclick="deleteUser(<%= u.id %>)">
                            <i class="bi bi-trash"></i> Delete
                          </button>
                          <% } else { %>
                          <span class="text-muted">(You)</span>
                          <% } %>
                        </td>
                      </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Blogs Tab -->
          <div class="tab-pane fade" id="blogs">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Blog Management</h2>
              <span class="badge bg-primary"><%= blogs.length %> total blogs</span>
            </div>
            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Created</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% blogs.forEach(b => { %>
                      <tr id="blog-row-<%= b.id %>">
                        <td><%= b.id %></td>
                        <td><strong><%= b.title ? b.title.substring(0, 50) : 'Untitled' %></strong></td>
                        <td><%= b.authorName || 'Unknown' %></td>
                        <td><%= b.createdAt || '-' %></td>
                        <td>
                          <a href="/blogs/<%= b.id %>" class="btn btn-sm btn-info btn-action">
                            <i class="bi bi-eye"></i> View
                          </a>
                          <button class="btn btn-sm btn-danger btn-action" onclick="deleteBlog(<%= b.id %>)">
                            <i class="bi bi-trash"></i> Delete
                          </button>
                        </td>
                      </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Forum Tab -->
          <div class="tab-pane fade" id="forum">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Forum Management</h2>
              <span class="badge bg-primary"><%= threads.filter(t => !t.archived).length %> active threads</span>
            </div>
            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Comments</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% threads.filter(t => !t.archived).forEach(t => { %>
                      <tr id="thread-row-<%= t.id %>">
                        <td><%= t.id %></td>
                        <td><strong><%= t.title ? t.title.substring(0, 40) : 'Untitled' %></strong></td>
                        <td><%= t.author || 'Unknown' %></td>
                        <td><%= t.comments ? t.comments.length : 0 %></td>
                        <td>
                          <span class="badge badge-active">Active</span>
                        </td>
                        <td>
                          <button class="btn btn-sm btn-secondary btn-action" onclick="archiveThread(<%= t.id %>)">
                            <i class="bi bi-archive"></i> Archive
                          </button>
                          <button class="btn btn-sm btn-info btn-action" onclick="viewThreadPosts(<%= t.id %>)">
                            <i class="bi bi-chat-dots"></i> Posts
                          </button>
                          <button class="btn btn-sm btn-danger btn-action" onclick="deleteThread(<%= t.id %>)">
                            <i class="bi bi-trash"></i> Delete
                          </button>
                        </td>
                      </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Archived Content Tab -->
          <div class="tab-pane fade" id="archived">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2>Archived Content</h2>
              <span class="badge bg-secondary"><%= threads.filter(t => t.archived).length %> archived threads</span>
            </div>
            <div class="card">
              <div class="card-header">
                <i class="bi bi-archive me-2"></i> Archived Threads
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Author</th>
                        <th>Archived At</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="archived-threads-body">
                      <% threads.filter(t => t.archived).forEach(t => { %>
                      <tr id="archived-thread-row-<%= t.id %>">
                        <td><%= t.id %></td>
                        <td>
                          <strong><%= t.title ? t.title.substring(0, 40) : 'Untitled' %></strong>
                          <span class="badge badge-archived archived-badge ms-2">Archived</span>
                        </td>
                        <td><%= t.author || 'Unknown' %></td>
                        <td><%= t.archivedAt ? new Date(t.archivedAt).toLocaleDateString() : '-' %></td>
                        <td>
                          <button class="btn btn-sm btn-success btn-action" onclick="unarchiveThread(<%= t.id %>)">
                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                          </button>
                          <button class="btn btn-sm btn-info btn-action" onclick="viewThreadPosts(<%= t.id %>)">
                            <i class="bi bi-chat-dots"></i> Posts
                          </button>
                          <button class="btn btn-sm btn-danger btn-action" onclick="deleteThread(<%= t.id %>)">
                            <i class="bi bi-trash"></i> Delete
                          </button>
                        </td>
                      </tr>
                      <% }) %>
                      <% if (threads.filter(t => t.archived).length === 0) { %>
                      <tr>
                        <td colspan="5" class="text-center text-muted py-4">No archived threads</td>
                      </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Thread Posts Modal -->
  <div class="modal fade" id="postsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thread Posts/Comments</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="posts-container">
            <p class="text-center text-muted">Loading...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // User Management
    async function toggleLock(userId) {
      if (!confirm('Are you sure you want to toggle this user\'s lock status?')) return;
      
      try {
        const res = await fetch(`/admin/users/${userId}/toggle-lock`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          const statusBadge = document.getElementById(`status-${userId}`);
          const lockBtn = document.getElementById(`lock-btn-${userId}`);
          
          if (data.locked) {
            statusBadge.className = 'badge badge-locked';
            statusBadge.textContent = 'Locked';
            lockBtn.className = 'btn btn-sm btn-success btn-action';
            lockBtn.innerHTML = '<i class="bi bi-unlock"></i> Unlock';
          } else {
            statusBadge.className = 'badge badge-active';
            statusBadge.textContent = 'Active';
            lockBtn.className = 'btn btn-sm btn-warning btn-action';
            lockBtn.innerHTML = '<i class="bi bi-lock"></i> Lock';
          }
        } else {
          alert(data.error || 'Error toggling lock status');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to DELETE this user? This cannot be undone!')) return;
      
      try {
        const res = await fetch(`/admin/users/${userId}/delete`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          document.getElementById(`user-row-${userId}`).remove();
        } else {
          alert(data.error || 'Error deleting user');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function changeRole(userId, role) {
      try {
        const res = await fetch(`/admin/users/${userId}/role`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role })
        });
        const data = await res.json();
        
        if (!data.success) {
          alert(data.error || 'Error changing role');
          location.reload();
        }
      } catch (err) {
        alert('Error: ' + err.message);
        location.reload();
      }
    }

    // Blog Management
    async function deleteBlog(blogId) {
      if (!confirm('Are you sure you want to DELETE this blog? This cannot be undone!')) return;
      
      try {
        const res = await fetch(`/admin/blogs/${blogId}/delete`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          document.getElementById(`blog-row-${blogId}`).remove();
        } else {
          alert(data.error || 'Error deleting blog');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Forum Management - Archive Thread
    async function archiveThread(threadId) {
      if (!confirm('Are you sure you want to ARCHIVE this thread? Users will no longer be able to view or comment on it.')) return;
      
      try {
        const res = await fetch(`/admin/forum/${threadId}/archive`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert(data.error || 'Error archiving thread');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Forum Management - Unarchive Thread
    async function unarchiveThread(threadId) {
      if (!confirm('Are you sure you want to RESTORE this thread?')) return;
      
      try {
        const res = await fetch(`/admin/forum/${threadId}/archive`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert(data.error || 'Error restoring thread');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Forum Management - Delete Thread
    async function deleteThread(threadId) {
      if (!confirm('Are you sure you want to PERMANENTLY DELETE this thread? This cannot be undone!')) return;
      
      try {
        const res = await fetch(`/admin/forum/${threadId}/delete`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          const row = document.getElementById(`thread-row-${threadId}`) || 
                      document.getElementById(`archived-thread-row-${threadId}`);
          if (row) row.remove();
        } else {
          alert(data.error || 'Error deleting thread');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // View Thread Posts (Comments)
    async function viewThreadPosts(threadId) {
      const container = document.getElementById('posts-container');
      container.innerHTML = '<p class="text-center text-muted">Loading...</p>';
      
      const modal = new bootstrap.Modal(document.getElementById('postsModal'));
      modal.show();
      
      try {
        const res = await fetch(`/api/forum/${threadId}`);
        const thread = await res.json();
        
        if (!thread.comments || thread.comments.length === 0) {
          container.innerHTML = '<p class="text-center text-muted">No comments in this thread</p>';
          return;
        }
        
        let html = `<h6 class="mb-3">Thread: ${thread.title}</h6>`;
        html += '<table class="table table-sm">';
        html += '<thead><tr><th>ID</th><th>Author</th><th>Comment</th><th>Status</th><th>Actions</th></tr></thead>';
        html += '<tbody>';
        
        thread.comments.forEach(comment => {
          const isArchived = comment.archived;
          html += `<tr id="post-row-${comment.id}" class="${isArchived ? 'archived-row' : ''}">`;
          html += `<td>${comment.id}</td>`;
          html += `<td>${comment.author || 'Unknown'}</td>`;
          html += `<td>${comment.text ? comment.text.substring(0, 50) : ''}...</td>`;
          html += `<td><span class="badge ${isArchived ? 'badge-archived' : 'badge-active'}">${isArchived ? 'Archived' : 'Active'}</span></td>`;
          html += `<td>`;
          html += `<button class="btn btn-sm ${isArchived ? 'btn-success' : 'btn-secondary'} btn-action" onclick="archivePost(${threadId}, ${comment.id})">`;
          html += `<i class="bi ${isArchived ? 'bi-arrow-counterclockwise' : 'bi-archive'}"></i> ${isArchived ? 'Restore' : 'Archive'}`;
          html += `</button>`;
          html += `</td>`;
          html += `</tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (err) {
        container.innerHTML = '<p class="text-center text-danger">Error loading posts: ' + err.message + '</p>';
      }
    }

    // Archive/Unarchive Post (Comment)
    async function archivePost(threadId, postId) {
      try {
        const res = await fetch(`/admin/forum/${threadId}/posts/${postId}/archive`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          // Refresh the posts view
          viewThreadPosts(threadId);
        } else {
          alert(data.error || 'Error archiving/restoring post');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }
  </script>
</body>
</html>
