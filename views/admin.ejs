<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel - Sport Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>

<div class="d-flex">

  <!-- Sidebar -->
  <div class="bg-light p-3" style="width: 250px; min-height: 100vh;">
    <h5 class="fw-bold">Admin Panel</h5>
    <small class="text-muted">Sport Store</small>
    <ul class="nav flex-column mt-4">
      <li class="nav-item"><a class="nav-link active" href="#users-section">Users</a></li>
      <li class="nav-item"><a class="nav-link" href="#blogs-section">Blogs</a></li>
      <li class="nav-item"><a class="nav-link" href="#forum-section">Forum</a></li>
      <li class="nav-item"><a class="nav-link" href="#archived-section">Archived</a></li>
      <hr>
      <li class="nav-item"><a class="nav-link" href="/shop">Back to Shop</a></li>
      <li class="nav-item"><a class="nav-link text-danger" href="/logout">Logout</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="flex-grow-1 p-4">

    <!-- Stats Overview -->
    <section class="mb-5">
      <h4>Dashboard Overview</h4>
      <div class="row mt-3">
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h6 class="text-muted">Total Users</h6>
              <h3><%= users.length %></h3>
              <small class="text-muted"><%= users.filter(u => u.locked).length %> locked</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h6 class="text-muted">Total Blogs</h6>
              <h3><%= blogs.length %></h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h6 class="text-muted">Forum Threads</h6>
              <h3><%= threads.filter(t => !t.archived).length %></h3>
              <small class="text-muted">active threads</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h6 class="text-muted">Archived</h6>
              <h3><%= threads.filter(t => t.archived).length %></h3>
              <small class="text-muted">threads archived</small>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Users Section -->
    <section id="users-section" class="mb-5">
      <h4>Users Management</h4>
      <table class="table table-bordered mt-3">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Full Name</th>
            <th>Role</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(u => { %>
          <tr id="user-row-<%= u.id %>">
            <td><%= u.id %></td>
            <td><strong><%= u.username %></strong></td>
            <td><%= u.email %></td>
            <td><%= u.fullname || '-' %></td>
            <td>
              <select class="form-select form-select-sm" style="width: auto;" 
                      onchange="changeRole('<%= u.id %>', this.value)"
                      <%= u.id === user.id ? 'disabled' : '' %>>
                <option value="user" <%= u.role === 'user' ? 'selected' : '' %>>User</option>
                <option value="admin" <%= u.role === 'admin' ? 'selected' : '' %>>Admin</option>
              </select>
            </td>
            <td>
              <span class="badge <%= u.locked ? 'bg-danger' : 'bg-success' %>" id="status-<%= u.id %>">
                <%= u.locked ? 'Locked' : 'Active' %>
              </span>
            </td>
            <td>
              <% if (u.id !== user.id) { %>
              <button class="btn btn-sm <%= u.locked ? 'btn-success' : 'btn-warning' %>" 
                      onclick="toggleLock('<%= u.id %>')" id="lock-btn-<%= u.id %>">
                <%= u.locked ? 'Unlock' : 'Lock' %>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser('<%= u.id %>')">Delete</button>
              <% } else { %>
              <span class="text-muted">(You)</span>
              <% } %>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </section>

    <!-- Blogs Section -->
    <section id="blogs-section" class="mb-5">
      <h4>Blogs Management</h4>
      <table class="table table-bordered mt-3">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Author</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% blogs.forEach(b => { %>
          <tr id="blog-row-<%= b.id %>">
            <td><%= b.id %></td>
            <td><strong><%= b.title ? b.title.substring(0, 50) : 'Untitled' %></strong></td>
            <td><%= b.authorName || 'Unknown' %></td>
            <td><%= b.createdAt || '-' %></td>
            <td>
              <a href="/blogs/<%= b.id %>" class="btn btn-sm btn-secondary">View</a>
              <button class="btn btn-sm btn-danger" onclick="deleteBlog('<%= b.id %>')">Delete</button>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </section>

    <!-- Forum Section -->
    <section id="forum-section" class="mb-5">
      <h4>Forum Management</h4>
      <table class="table table-bordered mt-3">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Thread Title</th>
            <th>Author</th>
            <th>Comments</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% threads.filter(t => !t.archived).forEach(t => { %>
          <tr id="thread-row-<%= t.id %>">
            <td><%= t.id %></td>
            <td><strong><%= t.title ? t.title.substring(0, 40) : 'Untitled' %></strong></td>
            <td><%= t.author || 'Unknown' %></td>
            <td><%= t.comments ? t.comments.length : 0 %></td>
            <td><span class="badge bg-success">Active</span></td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="archiveThread('<%= t.id %>')">Archive</button>
              <button class="btn btn-sm btn-secondary" onclick="viewThreadPosts('<%= t.id %>')">Posts</button>
              <button class="btn btn-sm btn-danger" onclick="deleteThread('<%= t.id %>')">Delete</button>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </section>

    <!-- Archived Section -->
    <section id="archived-section">
      <h4>Archived Content</h4>
      <table class="table table-bordered mt-3">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Author</th>
            <th>Archived At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="archived-threads-body">
          <% threads.filter(t => t.archived).forEach(t => { %>
          <tr id="archived-thread-row-<%= t.id %>">
            <td><%= t.id %></td>
            <td>
              <strong><%= t.title ? t.title.substring(0, 40) : 'Untitled' %></strong>
              <span class="badge bg-secondary ms-2">Archived</span>
            </td>
            <td><%= t.author || 'Unknown' %></td>
            <td><%= t.archivedAt ? new Date(t.archivedAt).toLocaleDateString() : '-' %></td>
            <td>
              <button class="btn btn-sm btn-success" onclick="unarchiveThread('<%= t.id %>')">Restore</button>
              <button class="btn btn-sm btn-secondary" onclick="viewThreadPosts('<%= t.id %>')">Posts</button>
              <button class="btn btn-sm btn-danger" onclick="deleteThread('<%= t.id %>')">Delete</button>
            </td>
          </tr>
          <% }) %>
          <% if (threads.filter(t => t.archived).length === 0) { %>
          <tr>
            <td colspan="5" class="text-center text-muted py-4">No archived threads</td>
          </tr>
          <% } %>
        </tbody>
      </table>
    </section>

  </div>
</div>

<!-- Thread Posts Modal -->
<div class="modal fade" id="postsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thread Posts/Comments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="posts-container">
          <p class="text-center text-muted">Loading...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // User Management
  async function toggleLock(userId) {
    if (!confirm('Are you sure you want to toggle this user\'s lock status?')) return;
    
    try {
      const res = await fetch(`/admin/users/${userId}/toggle-lock`, { method: 'POST' });
      const data = await res.json();
      
      if (data.success) {
        const statusBadge = document.getElementById(`status-${userId}`);
        const lockBtn = document.getElementById(`lock-btn-${userId}`);
        
        if (data.locked) {
          statusBadge.className = 'badge bg-danger';
          statusBadge.textContent = 'Locked';
          lockBtn.className = 'btn btn-sm btn-success';
          lockBtn.textContent = 'Unlock';
        } else {
          statusBadge.className = 'badge bg-success';
          statusBadge.textContent = 'Active';
          lockBtn.className = 'btn btn-sm btn-warning';
          lockBtn.textContent = 'Lock';
        }
      } else {
        alert(data.error || 'Error toggling lock status');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  async function deleteUser(userId) {
    if (!confirm('Are you sure you want to DELETE this user? This cannot be undone!')) return;
    
    try {
      const res = await fetch(`/admin/users/${userId}/delete`, { method: 'POST' });
      const data = await res.json();
      
      if (data.success) {
        document.getElementById(`user-row-${userId}`).remove();
      } else {
        alert(data.error || 'Error deleting user');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  async function changeRole(userId, role) {
    try {
      const res = await fetch(`/admin/users/${userId}/role`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role })
      });
      const data = await res.json();
      
      if (!data.success) {
        alert(data.error || 'Error changing role');
        location.reload();
      }
    } catch (err) {
      alert('Error: ' + err.message);
      location.reload();
    }
  }

  // Blog Management
  async function deleteBlog(blogId) {
    if (!confirm('Are you sure you want to DELETE this blog? This cannot be undone!')) return;
    
    try {
      const res = await fetch(`/admin/blogs/${blogId}/delete`, { method: 'POST' });
      const data = await res.json();
      
      if (data.success) {
        document.getElementById(`blog-row-${blogId}`).remove();
      } else {
        alert(data.error || 'Error deleting blog');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  // Forum Management - Archive Thread
  async function archiveThread(threadId) {
    if (!confirm('Are you sure you want to ARCHIVE this thread? Users will no longer be able to view or comment on it.')) return;
    
    try {
      const res = await fetch(`/admin/forum/${threadId}/archive`, { method: 'POST' });
      const data = await res.json();
      
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert(data.error || 'Error archiving thread');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  // Forum Management - Unarchive Thread
  async function unarchiveThread(threadId) {
    if (!confirm('Are you sure you want to RESTORE this thread?')) return;
    
    try {
      const res = await fetch(`/admin/forum/${threadId}/archive`, { method: 'POST' });
      const data = await res.json();
      
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert(data.error || 'Error restoring thread');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  // Forum Management - Delete Thread
  async function deleteThread(threadId) {
    if (!confirm('Are you sure you want to PERMANENTLY DELETE this thread? This cannot be undone!')) return;
    
    try {
      const res = await fetch(`/admin/forum/${threadId}/delete`, { method: 'POST' });
      const data = await res.json();
      
      if (data.success) {
        const row = document.getElementById(`thread-row-${threadId}`) || 
                    document.getElementById(`archived-thread-row-${threadId}`);
        if (row) row.remove();
      } else {
        alert(data.error || 'Error deleting thread');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  // View Thread Posts (Comments)
  async function viewThreadPosts(threadId) {
    const container = document.getElementById('posts-container');
    container.innerHTML = '<p class="text-center text-muted">Loading...</p>';
    
    const modal = new bootstrap.Modal(document.getElementById('postsModal'));
    modal.show();
    
    try {
      const res = await fetch(`/api/forum/${threadId}`);
      const thread = await res.json();
      
      if (!thread.comments || thread.comments.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No comments in this thread</p>';
        return;
      }
      
      let html = `<h6 class="mb-3">Thread: ${thread.title}</h6>`;
      html += '<table class="table table-bordered table-sm">';
      html += '<thead class="table-light"><tr><th>ID</th><th>Author</th><th>Comment</th><th>Status</th><th>Actions</th></tr></thead>';
      html += '<tbody>';
      
      thread.comments.forEach(comment => {
        const isArchived = comment.archived;
        html += `<tr id="post-row-${comment.id}" class="${isArchived ? 'table-secondary' : ''}">`;
        html += `<td>${comment.id}</td>`;
        html += `<td>${comment.author || 'Unknown'}</td>`;
        html += `<td>${comment.text ? comment.text.substring(0, 50) : ''}...</td>`;
        html += `<td><span class="badge ${isArchived ? 'bg-secondary' : 'bg-success'}">${isArchived ? 'Archived' : 'Active'}</span></td>`;
        html += `<td>`;
        html += `<button class="btn btn-sm ${isArchived ? 'btn-success' : 'btn-warning'}" onclick="archivePost('${threadId}', '${comment.id}')">`;
        html += `${isArchived ? 'Restore' : 'Archive'}`;
        html += `</button>`;
        html += `</td>`;
        html += `</tr>`;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    } catch (err) {
      container.innerHTML = '<p class="text-center text-danger">Error loading posts: ' + err.message + '</p>';
    }
  }

  // Archive/Unarchive Post (Comment)
  async function archivePost(threadId, postId) {
    try {
      const res = await fetch(`/admin/forum/${threadId}/posts/${postId}/archive`, { method: 'POST' });
      const data = await res.json();
      
      if (data.success) {
        // Refresh the posts view
        viewThreadPosts(threadId);
      } else {
        alert(data.error || 'Error archiving/restoring post');
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }
</script>
</body>
</html>
