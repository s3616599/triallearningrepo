<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%= thread.title %> - Forum</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/globals.css" />
    <link rel="stylesheet" href="/css/styleguide.css" />
    <link rel="stylesheet" href="/css/style.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
      .thread-detail-card {
        border-radius: 12px;
        padding: 24px;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .thread-meta {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
      }

      .thread-image {
        width: 100%;
        max-height: 500px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 1.5rem;
      }

      .comment-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #e5e7eb;
      }

      .comment-box {
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 1rem;
      }

      .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .comment-author {
        font-weight: 600;
        color: #111827;
      }

      .comment-time {
        font-size: 0.875rem;
        color: #6b7280;
      }

      .comment-text {
        color: #374151;
        line-height: 1.6;
      }

      .comment-actions {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
      }

      .new-comment-form {
        margin-top: 2rem;
        padding: 1.5rem;
        background: #f9fafb;
        border-radius: 8px;
      }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg bg-light border-bottom py-3">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">Ecommerce</a>

        <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navMenu">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div id="navMenu" class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto ms-4 gap-3">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="/shop">Shop</a></li>
                <li class="nav-item"><a class="nav-link" href="/blogs">Blogs</a></li>
                <li class="nav-item"><a class="nav-link active" href="/forum">Forum</a></li>
                <li class="nav-item"><a class="nav-link" href="/sitemap">Site Map</a></li>
            </ul>

            <form class="d-flex me-3" action="/search" method="GET">
                <input class="form-control" type="search" name="q" placeholder="Search products">
            </form>

            <a href="/cart" class="me-3"><i class="fa-solid fa-bag-shopping fs-5"></i></a>
            <% if (user) { %>
                <a href="/account"><i class="fa-solid fa-user fs-5"></i></a>
            <% } else { %>
                <a href="/login"><i class="fa-regular fa-user fs-5"></i></a>
            <% } %>
        </div>
    </div>
</nav>

<!-- Breadcrumb -->
<nav class="bg-light py-2 border-bottom">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/">Ecommerce</a></li>
            <li class="breadcrumb-item"><a href="/forum">Forum</a></li>
            <li class="breadcrumb-item active"><%= thread.title %></li>
        </ol>
    </div>
</nav>

<!-- Thread Content -->
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="thread-detail-card">
                <!-- Back Button -->
                <a href="/forum" class="btn btn-outline-secondary btn-sm mb-3">
                    <i class="fas fa-arrow-left"></i> Back to Forum
                </a>

                <!-- Thread Title -->
                <h2 class="fw-bold mb-3"><%= thread.title %></h2>

                <!-- Thread Meta -->
                <div class="thread-meta">
                    <span><%= thread.meta || 'By SportStore' %></span>
                    <span class="mx-2">•</span>
                    <span><%= new Date(thread.createdAt || thread.created).toLocaleDateString() %></span>
                </div>

                <!-- Tags -->
                <% if (thread.tags && thread.tags.length > 0) { %>
                    <div class="mb-3">
                        <% thread.tags.forEach(function(tag) { %>
                            <span class="badge bg-secondary me-1"><%= tag %></span>
                        <% }); %>
                    </div>
                <% } %>

                <!-- Thread Image -->
                <% if (thread.image) { %>
                    <img src="<%= thread.image %>" alt="<%= thread.title %>" class="thread-image">
                <% } %>

                <!-- Thread Body -->
                <div class="thread-body">
                    <p style="white-space: pre-wrap;"><%= thread.body %></p>
                </div>

                <!-- Thread Actions -->
                <% if (user && (user._id.toString() === thread.author.toString() || user.isAdmin)) { %>
                    <div class="mt-4 pt-3 border-top">
                        <a href="/forum/threads/<%= thread._id %>/edit" class="btn btn-primary btn-sm">
                            <i class="fas fa-edit"></i> Edit Thread
                        </a>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteThread()">
                            <i class="fas fa-trash"></i> Delete Thread
                        </button>
                    </div>
                <% } %>

                <!-- Comments Section -->
                <div class="comment-section">
                    <h4 class="mb-4">
                        Comments 
                        <span class="badge bg-secondary"><%= thread.comments ? thread.comments.length : 0 %></span>
                    </h4>

                    <!-- Comment List -->
                    <% if (thread.comments && thread.comments.length > 0) { %>
                        <% thread.comments.forEach(function(comment) { %>
                            <div class="comment-box">
                                <div class="comment-header">
                                    <span class="comment-author"><%= comment.author || comment.authorName || 'User' %></span>
                                    <span class="comment-time"><%= new Date(comment.createdAt || comment.created).toLocaleString() %></span>
                                </div>
                                <p class="comment-text mb-0"><%= comment.text || comment.content %></p>
                                
                                <% if (user && (user._id.toString() === comment.authorId?.toString() || user.isAdmin)) { %>
                                    <div class="comment-actions">
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteComment('<%= comment._id %>')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                <% } %>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="alert alert-info">
                            No comments yet. Be the first to comment!
                        </div>
                    <% } %>

                    <!-- New Comment Form -->
                    <% if (user) { %>
                        <div class="new-comment-form">
                            <h5 class="mb-3">Add a Comment</h5>
                            <form action="/forum/threads/<%= thread._id %>/comments" method="POST">
                                <div class="mb-3">
                                    <textarea 
                                        name="text" 
                                        class="form-control" 
                                        rows="4" 
                                        placeholder="Share your thoughts..." 
                                        maxlength="500"
                                        required
                                    ></textarea>
                                    <small class="text-muted">Maximum 500 characters</small>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Post Comment
                                </button>
                            </form>
                        </div>
                    <% } else { %>
                        <div class="alert alert-info mt-4">
                            Please <a href="/login">login</a> to post a comment.
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="bg-light pt-5 mt-5">
  <div class="container">
    <div class="row">
      <div class="col-md-3 mb-4">
        <div class="d-flex align-items-center gap-2 mb-2">
          <div class="p-2 border rounded"><i class="fa-solid fa-store fs-3"></i></div>
          <span class="fw-bold fs-5">Ecommerce</span>
        </div>
        <p class="text-muted small">DevCut is a YouTube channel for practical project-based learning.</p>
        <div class="d-flex gap-2 mt-2">
            <i class="fab fa-github fs-5"></i>
            <i class="fab fa-instagram fs-5"></i>
            <i class="fab fa-youtube fs-5"></i>
        </div>
      </div>

      <div class="col-md-2 mb-4">
        <h6 class="text-muted">SHOP</h6>
        <ul class="list-unstyled mt-2">
          <li><a href="/account" class="text-decoration-none text-dark">My Account</a></li>
          <li><a href="/checkout" class="text-decoration-none text-dark">Checkout</a></li>
          <li><a href="/cart" class="text-decoration-none text-dark">Cart</a></li>
        </ul>
      </div>

      <div class="col-md-2 mb-4">
        <h6 class="text-muted">COMPANY</h6>
        <ul class="list-unstyled mt-2">
          <li><a href="/about" class="text-decoration-none text-dark">About us</a></li>
          <li><a href="/contact" class="text-decoration-none text-dark">Contact</a></li>
          <li><a href="/careers" class="text-decoration-none text-dark">Careers</a></li>
        </ul>
      </div>

      <div class="col-md-2 mb-4">
        <h6 class="text-muted">SUPPORT</h6>
        <ul class="list-unstyled mt-2">
          <li><a href="/faq" class="text-decoration-none text-dark">FAQ</a></li>
          <li><a href="/terms" class="text-decoration-none text-dark">Terms of use</a></li>
          <li><a href="/privacy" class="text-decoration-none text-dark">Privacy Policy</a></li>
        </ul>
      </div>

      <div class="col-md-3 mb-4">
          <h6 class="text-muted">ACCEPTED PAYMENTS</h6>
          <div class="d-flex gap-2 mt-2">
              <i class="fa-brands fa-cc-visa fs-3"></i>
              <i class="fa-brands fa-cc-mastercard fs-3"></i>
              <i class="fa-brands fa-cc-amex fs-3"></i>
              <i class="fa-brands fa-cc-paypal fs-3"></i>
          </div>
      </div>
    </div>

    <hr class="mt-4">

    <div class="text-center pb-3 small text-muted">
      © 2025 DevCut. All rights reserved.
    </div>
  </div>
</footer>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
function deleteThread() {
    if (confirm('Are you sure you want to delete this thread? This action cannot be undone.')) {
        fetch('/forum/threads/<%= thread._id %>', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/forum';
            } else {
                alert('Failed to delete thread. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
}

function deleteComment(commentId) {
    if (confirm('Are you sure you want to delete this comment?')) {
        fetch('/forum/threads/<%= thread._id %>/comments/' + commentId, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to delete comment. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
}
</script>

</body>
</html>
